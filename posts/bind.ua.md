# Парадокс Bootstrap: BIND, Glue Records та Реєстр

> **Вас неможливо знайти, якщо ви не існуєте. Але ви не можете існувати, доки вас не знайдуть.**

У попередній статті ми побудували стек LAMP/FAMP. У нас є веб-сервер, що слухає на IP-адресі. Але користувачі не вводять IP-адреси; вони вводять імена.

Щоб перетворити `192.0.2.10` на `d3ep0ps.com`, нам потрібен DNS.

Більшість сучасних інженерів ставляться до DNS як до SaaS. Ви купуєте домен на GoDaddy, вказуєте NS-записи на хмари AWS, GCP, Azure і забуваєте про це. Ви стаєте **Споживачем** DNS.

Але щоб зрозуміти, як насправді працює інтернет, ви повинні стати **Провайдером**. Ви повинні запустити свій власний Авторитетний Неймсервер (Authoritative Name Server).

І коли ви спробуєте це зробити — коли ви спробуєте хостити `d3ep0ps.com`, використовуючи неймсервер з назвою `ns1.d3ep0ps.com` — ви вріжетеся в логічну стіну, яка ламала мозок кожному джуніор-сисадміну з 1980-х: **Парадокс Bootstrap.**

Щоб вирішити його, ми повинні поглянути на рівень вище нас: **Реєстр.**

## 1\. Вигляд згори: Я керував "телефонною книгою"

Перш ніж ми встановимо BIND, дозвольте мені поділитися перспективою, яку більшість адмінів ніколи не бачать.

Роками раніше одним з моїх обов'язків було керування зоною `lviv.ua`.
Це було не про налаштовування свої власних доменів; я відповідав за **Реєстр**, на який покладалися інші люди. Я підтримував базу даних, яка казала: "Якщо ви шукаєте `company.lviv.ua`, йдіть поговоріть з цими неймсерверами".

З цієї точки ви розумієте, що DNS — це не магія. Це сувора ієрархія делегування. І ця ієрархія покладається на протокол, старіший за сам веб: **WHOIS**.

### WHOIS — це не тільки про приватність

Більшість людей думають, що WHOIS — це просто інструмент, щоб побачити, хто володіє доменом (або щоб сховатися від спаму).
Але технічно, WHOIS (що працює на **TCP порту 43**) — це база даних "Реєстру".

Коли ви купуєте домен, ваш Реєстратор надсилає дані до WHOIS-бази "Реєстру".
"Реєстр" потім використовує цю базу даних, щоб **згенерувати файл зони TLD**.

Якщо ваших неймсерверів немає в базі WHOIS, їх немає у файлі зони `.com` (або `.ua`). А якщо їх там немає, ви не існуєте.

## 2\. Парадокс Bootstrap (Glue Records)

Ось у чому проблема.

1.  Я купую `d3ep0ps.com` у Реєстратора
2.  Я хочу хостити свій власний DNS. Тому я будую сервер на IP `1.2.3.4`.
3.  Я називаю цей сервер `ns1.d3ep0ps.com`.
4.  Я кажу Реєстратору: "Неймсервер для `d3ep0ps.com` — це `ns1.d3ep0ps.com`."

Тепер уявіть користувача, який намагається відвідати мій сайт.

1.  **Користувач:** "Привіт `.com`, де знаходиться `d3ep0ps.com`?"
2.  **Реєстр (.com):** "Йди запитай у `ns1.d3ep0ps.com`."
3.  **Користувач:** "Чудово. А де знаходиться `ns1.d3ep0ps.com`?"
4.  **Реєстр:** "Він всередині `d3ep0ps.com`. Йди запитай у неймсервера для `d3ep0ps.com`."
5.  **Користувач:** "Але... це той самий сервер, який я намагаюся знайти!"

**Це циклічна залежність.** Ви не можете розрезолвити ім'я неймсервера, тому що воно живе всередині домену, який воно повинно обслуговувати.

### Рішення: Glue Records

Щоб розірвати петлю, Реєстр дозволяє вам "схитрувати".
Коли ви визначаєте свій неймсервер на рівні Реєстратора, ви надаєте **і Ім'я, І IP-адресу**.

Реєстр бере цю IP-адресу і вставляє її безпосередньо у файл зони TLD як "A-запис" поруч із "NS-записом". Це "приклеює" (glues) ім'я до IP, дозволяючи резолверу пропустити пошук і піти прямо на вашу IP-адресу.

**Урок:** Якщо ви змінюєте IP вашого BIND сервера, ви не можете просто оновити свій файл зони. Ви повинні оновити через **Реєстратора**  базу **WHOIS**, інакше ваш сайт згасне.

## 3\. Встановлення: Linux проти FreeBSD

Тепер, коли Реєстр знає про нас (через Glue Records), нам потрібно налаштувати програмне забезпечення, щоб відповідати на запити. Ми будемо використовувати **BIND** (Berkeley Internet Name Domain), стандарт з часів зародження інтернету.

### Linux (Debian/Ubuntu)

```bash
sudo apt update
sudo apt install bind9 bind9utils bind9-doc
```

  * **Конфіг:** `/etc/bind/`
  * **Файли зон:** `/var/lib/bind/` (зазвичай)
  * **Безпека:** Працює від користувача `bind`, але часто сидить у стандартному просторі імен файлової системи, якщо ви не налаштуєте AppArmor.

### FreeBSD (Безпечний Дефолт)

FreeBSD ставиться до BIND з надзвичайною обережністю.

```bash
sudo pkg update
sudo pkg install bind916 bind916-tools bind916-doc
```

  * **Конфіг:** `/usr/local/etc/namedb/`
  * **Різниця:** FreeBSD наполегливо рекомендує (і часто робить це дефолтом) запускати BIND у **chroot jail**.
    Він працює всередині `/var/named/`.
      * `/etc` всередині jail — це насправді `/var/named/etc/`.
      * Якщо хакер експлуатує вразливість у BIND, він опиняється в пастці в директорії, де немає нічого, крім файлів зон. Він не може побачити `/etc/passwd` або отримати доступ до решти ОС.

Щоб увімкнути це в `/etc/rc.conf`:

```bash
sysrc named_enable="YES"
sysrc named_chrootdir="/var/named"
```

## 4\. Конфігурація: Анатомія Авторитету

Ми повинні сказати BIND дві речі:

1.  **Глобальні Опції:** Хто може говорити з нами?
2.  **Зона:** Які записи ми тримаємо?

### named.conf (Глобальні Опції)

Найбільш критичне налаштування для хостинг-сервера — це **Вимкнення Рекурсії**.

**Кошмар Хостинг-Провайдера:**
Якщо ви дозволите "Recursion: Yes" та "Allow-query: Any", ваш сервер відповідатиме на запити для *будь-якого* домену (наприклад, google.com). Зловмисники використають ваш сервер для запуску **DNS Amplification DDoS атак**.

Ваш конфіг повинен виглядати так (безпечно):

```text
options {
    directory "/usr/local/etc/namedb/working"; # Шлях FreeBSD
    recursion no;              # НЕ будьте резолвером для світу
    allow-transfer { none; };  # Не дозволяйте незнайомцям красти вашу зону
    listen-on-v6 { any; };     # Це 2025 рік. Використовуйте IPv6.
};
```

### Файл Зони (`d3ep0ps.com.db`)

Це база даних вашого домену.

```text
$TTL    86400
@       IN      SOA     ns1.d3ep0ps.com. admin.d3ep0ps.com. (
                        2025120401      ; Serial (YYYYMMDDnn)
                        3600            ; Refresh
                        1800            ; Retry
                        604800          ; Expire
                        86400 )         ; Minimum TTL

; Name Servers (NS Records)
@       IN      NS      ns1.d3ep0ps.com.
@       IN      NS      ns2.d3ep0ps.com.

; Glue Records (Self-Reference)
ns1     IN      A       192.0.2.10
ns1     IN      AAAA    2001:db8::10

; Web Server
@       IN      A       192.0.2.10
www     IN      CNAME   @
```

**Ритуал Серійного Номера:**
Зверніть увагу на serial: `2025120401` (Дата + 01).
Кожного разу, коли ви редагуєте цей файл, ви **повинні** збільшувати це число. Вторинні неймсервери (слейви) дивляться на це число. Якщо воно не збільшилося, вони проігнорують ваші зміни. Я бачив простої, що тривали дні, тому що адмін забув підняти ціле число.

## 5\. Тестування: Більше ніж Ping

Як ви знаєте, що це працює? `ping` тут марний. Нам потрібен `dig`.

**1. Перевірка Синтаксису (Перед Перезапуском)**
Ніколи не перезапускайте BIND без перевірки синтаксису.

```bash
named-checkconf
named-checkzone d3ep0ps.com /usr/local/etc/namedb/master/d3ep0ps.com.db
```

**2. Локальний Тест**
Задайте вашому localhost конкретні питання.

```bash
dig @localhost d3ep0ps.com SOA
```

Ви повинні побачити вашу секцію "AUTHORITY SECTION" з даними, які ви щойно ввели.

**3. "Trace" (Реальний Інтернет-Тест)**
Це остаточний тест. Він обходить ваш кеш і проходить дерево від Кореня (.) до TLD (.com) і до вас.

```bash
dig +trace d3ep0ps.com
```

Дивіться на вивід.

1.  Він запитує Кореневі Сервери ("Де знаходиться .com?").
2.  Він запитує Сервери .com ("Де знаходиться d3ep0ps?"). -> **Цей крок працює завдяки Glue Record!**
3.  Він запитує Ваш Сервер ("Де знаходиться www?").

Якщо ланцюжок розривається на кроці 2, ваші Glue Records (WHOIS) неправильні.
Якщо він розривається на кроці 3, ваш конфіг BIND або Фаєрвол неправильні.

## Висновок

Ми вирішили парадокс.

1.  Ми сказали **Реєстру**, де знаходиться наш сервер (Glue).
2.  Ми сказали нашому **Серверу**, хто він є (BIND).
3.  Світ тепер може знайти `d3ep0ps.com`.

> Якщо ви хочете заглибитися в тему, я рекомендую прочитати [офіційну документацію BIND](https://www.isc.org/bind/) та книгу [DNS and BIND](https://www.oreilly.com/library/view/dns-and-bind/0596100574/) від Cricket Liu, Paul Albitz.

Наш сервер діє як Веб-Хост (Стаття 1) та Неймсервер (Стаття 2).
Але якщо ви спробуєте надіслати імейл на `admin@d3ep0ps.com`, він зникне.

Хостинг пошти — це найважче завдання в системному адмініструванні. Воно вимагає більше, ніж просто програмне забезпечення; воно вимагає **Репутації**.

**Далі:** "Поштовий Стек: Postfix, Dovecot та Війна зі Спамом."
