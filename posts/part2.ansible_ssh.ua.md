# –ß–µ–∫–ª—ñ—Å—Ç –ë–µ–∑–ø–µ–∫–∏ –°–µ—Ä–≤–µ—Ä–∞ –î–µ–Ω—å-1: –ü–æ–±—É–¥–æ–≤–∞ –ü–µ—Ä–∏–º–µ—Ç—Ä–∞ –Ω–∞ Linux —Ç–∞ FreeBSD

**–í–∏–π–¥—ñ—Ç—å –∑–∞ –º–µ–∂—ñ –∫–ª—é—á—ñ–≤. –ó–∞–≥–ª—É—à—ñ—Ç—å —à—É–º, –∑–∞–±–ª–æ–∫—É–π—Ç–µ –±–æ—Ç—ñ–≤ —ñ –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–π—Ç–µ –≤–∞—à –º–µ—Ä–µ–∂–µ–≤–∏–π –∑–∞—Ö–∏—Å—Ç.**

–£ **–ß–∞—Å—Ç–∏–Ω—ñ 1** —Ü—ñ—î—ó —Å–µ—Ä—ñ—ó, ["–ß–µ–∫–ª—ñ—Å—Ç –ë–µ–∑–ø–µ–∫–∏ –°–µ—Ä–≤–µ—Ä–∞ –î–µ–Ω—å-1: –ü–æ—Å–∏–ª–µ–Ω–Ω—è SSH,"](https://d3ep0ps.com/#part1_ansible_ssh) –º–∏ –∑–∞—Ö–∏—Å—Ç–∏–ª–∏ **–†—ñ–≤–µ–Ω—å –Ü–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ**. –ú–∏ –∑–∞–±–µ–∑–ø–µ—á–∏–ª–∏, —â–æ —î–¥–∏–Ω–∏–π —Å–ø–æ—Å—ñ–± —É–≤—ñ–π—Ç–∏ –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä ‚Äî —Ü–µ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—á–Ω–æ –±–µ–∑–ø–µ—á–Ω–∏–π –∫–ª—é—á, —ñ —â–æ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å root –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π —á–µ—Ä–µ–∑ SSH.

–ü–∞—Ä–∞–¥–Ω—ñ –¥–≤–µ—Ä—ñ –≤–∞—à–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –º–∞—é—Ç—å –∑–∞–º–æ–∫, —è–∫–∏–π –Ω–µ–º–æ–∂–ª–∏–≤–æ –∑–ª–∞–º–∞—Ç–∏ –≤—ñ–¥–º–∏—á–∫–æ—é.

–ê–ª–µ —à–ª—è—Ö –¥–æ —Ü–∏—Ö –¥–≤–µ—Ä–µ–π –≤–∏–¥–∏–º–∏–π –¥–ª—è –≤—Å—å–æ–≥–æ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –©–æ—Ö–≤–∏–ª–∏–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω—ñ —Å–∫–∞–Ω–µ—Ä–∏ —Å–º–∏–∫–∞—é—Ç—å —Ä—É—á–∫—É, —Ç–µ—Å—Ç—É—é—á–∏ –ø–æ—Ä—Ç 22, –∑–∞–ø–æ–≤–Ω—é—é—á–∏ –≤–∞—à—ñ –ª–æ–≥–∏ –Ω–µ–≤–¥–∞–ª–∏–º–∏ —Å–ø—Ä–æ–±–∞–º–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó. –¶–µ–π —à—É–º –º–∞—Å–∫—É—î —Ä–µ–∞–ª—å–Ω—ñ –∑–∞–≥—Ä–æ–∑–∏ —ñ –≤–∏—Ç—Ä–∞—á–∞—î —Ä–µ—Å—É—Ä—Å–∏ —Å–µ—Ä–≤–µ—Ä–∞.

–ù–∞—Å—Ç–∞–≤ —á–∞—Å –ø–æ–±—É–¥—É–≤–∞—Ç–∏ —Å—Ç—ñ–Ω—É –Ω–∞–≤–∫–æ–ª–æ —Å–µ—Ä–≤–µ—Ä–∞ —ñ –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –æ—Ö–æ—Ä–æ–Ω—Ü—è –±—ñ–ª—è –≤–æ—Ä—ñ—Ç.

–£ **–ß–∞—Å—Ç–∏–Ω—ñ 2** –º–∏ —Ñ–æ–∫—É—Å—É—î–º–æ—Å—è –Ω–∞ **–ú–µ—Ä–µ–∂–µ–≤–æ–º—É –ü–µ—Ä–∏–º–µ—Ç—Ä—ñ**. –ú–∏ —Ä–µ–∞–ª—ñ–∑—É—î–º–æ "–∑–∞—Ö–∏—Å—Ç —É –≥–ª–∏–±–∏–Ω—É" (defense in depth), –∑–º—ñ–Ω–∏–≤—à–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π –ø–æ—Ä—Ç SSH, —Ä–æ–∑–≥–æ—Ä–Ω—É–≤—à–∏ —Ñ–∞—î—Ä–≤–æ–ª –∑ –ø–æ–ª—ñ—Ç–∏–∫–æ—é "default-deny" (UFW –Ω–∞ Linux, PF –Ω–∞ FreeBSD) —ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–≤—à–∏ –∞–∫—Ç–∏–≤–Ω–∏–π –∑–∞—Ö–∏—Å—Ç –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Fail2Ban, –≤—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–æ –∑ Ansible.

## ‚ö†Ô∏è –ü—Ä–∞–≤–∏–ª–∞ –í–∑–∞—î–º–æ–¥—ñ—ó: –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –¶–µ –°–ø–æ—á–∞—Ç–∫—É

–ü–µ—Ä—à –Ω—ñ–∂ –º–∏ –ø–æ—á–Ω–µ–º–æ, –∫—Ä–∏—Ç–∏—á–Ω–µ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è. –ú–∏ –∑–±–∏—Ä–∞—î–º–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ –ø–æ—Ä—Ç, —è–∫–∏–π –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –≤–∞—à–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞, —ñ —É–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–∏—Å—Ç–µ–º—É, –ø—Ä–∏–∑–Ω–∞—á–µ–Ω—É –¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –º–µ—Ä–µ–∂–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ—ñ–∫—É.

**–ü–æ–º–∏–ª–∫–∏ —Ç—É—Ç –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ñ—á–Ω—ñ.** –Ø–∫—â–æ –≤–∏ –∑–º—ñ–Ω–∏—Ç–µ –ø–æ—Ä—Ç SSH —É –∫–æ–Ω—Ñ—ñ–≥—É, –∞–ª–µ –∑–∞–±—É–¥–µ—Ç–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –π–æ–≥–æ —É —Ñ–∞—î—Ä–≤–æ–ª—ñ, –∞–±–æ —è–∫—â–æ –≤–∏ —É–≤—ñ–º–∫–Ω–µ—Ç–µ —Ñ–∞—î—Ä–≤–æ–ª –¥–æ —Ç–æ–≥–æ, —è–∫ –¥–æ–∑–≤–æ–ª–∏—Ç–µ SSH, **–≤–∏ –∑–∞–±–ª–æ–∫—É—î—Ç–µ —Å–µ–±–µ –ø–æ–≤–Ω—ñ—Å—Ç—é.** –ù–µ–º–∞—î –∫–Ω–æ–ø–∫–∏ "—Å–∫–∞—Å—É–≤–∞—Ç–∏", —è–∫ —Ç—ñ–ª—å–∫–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è —Ä–æ–∑—ñ—Ä–≤–∞–Ω–æ.

–°–ª—ñ–¥—É–π—Ç–µ —Ü–∏–º –ø—Ä–∞–≤–∏–ª–∞–º, —â–æ–± –∑–∞–ª–∏—à–∞—Ç–∏—Å—è –≤ –±–µ–∑–ø–µ—Ü—ñ:

1.  **–ù—ñ–∫–æ–ª–∏ –Ω–µ –ø—Ä–∞—Ü—é–π—Ç–µ —Å–ø–æ—á–∞—Ç–∫—É –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä—ñ.** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—É VM (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Vagrant) –∞–±–æ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∏–π —Ö–º–∞—Ä–Ω–∏–π —ñ–Ω—Å—Ç–∞–Ω—Å –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤–∞—à–∏—Ö –ø–ª–µ–π–±—É–∫—ñ–≤.
2.  **–ó–∞–≤–∂–¥–∏ —Ç—Ä–∏–º–∞–π—Ç–µ –æ–¥–Ω—É root-—Å–µ—Å—ñ—é –≤—ñ–¥–∫—Ä–∏—Ç–æ—é.** –ü–µ—Ä–µ–¥ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è–º –∑–º—ñ–Ω, —è–∫—ñ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é—Ç—å SSH –∞–±–æ –≤–º–∏–∫–∞—é—Ç—å —Ñ–∞—î—Ä–≤–æ–ª, —Ç—Ä–∏–º–∞–π—Ç–µ –æ–¥–Ω–µ –∞–∫—Ç–∏–≤–Ω–µ —Ç–µ—Ä–º—ñ–Ω–∞–ª—å–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è –≤—ñ–¥–∫—Ä–∏—Ç–∏–º –¥–æ —Å–µ—Ä–≤–µ—Ä–∞. –Ø–∫—â–æ –≤–∏ –∑–∞–±–ª–æ–∫—É—î—Ç–µ —Å–µ–±–µ, —Ü—è —ñ—Å–Ω—É—é—á–∞ —Å–µ—Å—ñ—è –º–æ–∂–µ –±—É—Ç–∏ –≤–∞—à–∏–º —î–¥–∏–Ω–∏–º —à–ª—è—Ö–æ–º –Ω–∞–∑–∞–¥, —â–æ–± –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ —Ü–µ.
3.  **–ü–æ—Ä—è–¥–æ–∫ –º–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è.** –£ –Ω–∞—à—ñ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó –º–∏ –ø–æ–≤–∏–Ω–Ω—ñ –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –Ω–æ–≤–∏–π –ø–æ—Ä—Ç SSH –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π —É —Ñ–∞—î—Ä–≤–æ–ª—ñ *–¥–æ —Ç–æ–≥–æ*, —è–∫ –º–∏ –∑–º—ñ–Ω–∏–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é SSH —ñ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–º–æ —Å–µ—Ä–≤—ñ—Å.
4.  **–ü–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ —Å–≤—ñ–π –¥–æ—Å—Ç—É–ø –Ω–µ–≥–∞–π–Ω–æ.** –ü—ñ—Å–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –±—É–¥—å-—è–∫–∏—Ö –∑–º—ñ–Ω –≤—ñ–¥–∫—Ä–∏–π—Ç–µ *–Ω–æ–≤–µ* –≤—ñ–∫–Ω–æ —Ç–µ—Ä–º—ñ–Ω–∞–ª—É —ñ —Å–ø—Ä–æ–±—É–π—Ç–µ —É–≤—ñ–π—Ç–∏ –Ω–∞ –Ω–æ–≤–æ–º—É –ø–æ—Ä—Ç—É. –ù–µ –∑–∞–∫—Ä–∏–≤–∞–π—Ç–µ –≤–∞—à—É –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É —Å–µ—Å—ñ—é, –¥–æ–∫–∏ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —â–æ –Ω–æ–≤–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –ø—Ä–∞—Ü—é—î.

## 1\. –í–µ–ª–∏–∫—ñ –î–µ–±–∞—Ç–∏: –ó–º—ñ–Ω–∞ –ü–æ—Ä—Ç—É SSH

–ü–µ—Ä—à –Ω—ñ–∂ –º–∏ —Ç–æ—Ä–∫–Ω–µ–º–æ—Å—è —Ñ–∞—î—Ä–≤–æ–ª—É, –º–∏ –ø–æ–≤–∏–Ω–Ω—ñ —Ä–æ–∑–≥–ª—è–Ω—É—Ç–∏ –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏–π —ñ –Ω–∞–π—Å—É–ø–µ—Ä–µ—á–ª–∏–≤—ñ—à–∏–π –ø–µ—Ä—à–∏–π –∫—Ä–æ–∫ —É –ø–æ—Å–∏–ª–µ–Ω–Ω—ñ –±–µ–∑–ø–µ–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞: –∑–º—ñ–Ω–∞ –ø–æ—Ä—Ç—É SSH –∑ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ `22` –Ω–∞ —â–æ—Å—å —ñ–Ω—à–µ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `2222` –∞–±–æ `5757`).

–ö—Ä–∏—Ç–∏–∫–∏ —Å—Ç–≤–µ—Ä–¥–∂—É—é—Ç—å, —â–æ —Ü–µ "–±–µ–∑–ø–µ–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ—è—Å–Ω—ñ—Å—Ç—å" (security through obscurity). –í–æ–Ω–∏ –º–∞—é—Ç—å —Ä–∞—Ü—ñ—é. –†—ñ—à—É—á–∏–π –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –ø—Ä–æ—Å–∫–∞–Ω—É—î –≤–µ—Å—å –≤–∞—à —Å–µ—Ä–≤–µ—Ä —ñ –∑–Ω–∞–π–¥–µ SSH, –¥–µ –± –≤–∏ –π–æ–≥–æ –Ω–µ —Å—Ö–æ–≤–∞–ª–∏. –ó–º—ñ–Ω–∞ –ø–æ—Ä—Ç—É –Ω–µ –∑—É–ø–∏–Ω–∏—Ç—å —Ü—ñ–ª–µ—Å–ø—Ä—è–º–æ–≤–∞–Ω—É –∞—Ç–∞–∫—É.

**–¢–æ —á–æ–º—É –º–∏ —Ü–µ —Ä–æ–±–∏–º–æ?**

–ú–∏ —Ä–æ–±–∏–º–æ —Ü–µ –∑–∞—Ä–∞–¥–∏ **—Å–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è —Å–∏–≥–Ω–∞–ª/—à—É–º**.

99% –∞—Ç–∞–∫, —â–æ –±'—é—Ç—å –ø–æ –≤–∞—à–æ–º—É —Å–µ—Ä–≤–µ—Ä—É, ‚Äî —Ü–µ —Ç—É–ø—ñ —Å–∫—Ä–∏–ø—Ç–∏, —â–æ —Å–∫–∞–Ω—É—é—Ç—å –≤–µ—Å—å –∞–¥—Ä–µ—Å–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä IPv4 –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ—Ä—Ç—É 22. –ü–µ—Ä–µ–º—ñ—Å—Ç–∏–≤—à–∏ –≤–∞—à —Å–µ—Ä–≤—ñ—Å SSH –Ω–∞ –≤–∏—Å–æ–∫–∏–π, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –ø–æ—Ä—Ç, –≤–∏ –º–∏—Ç—Ç—î–≤–æ –∑–Ω–∏–∫–∞—î—Ç–µ –∑ —Ä–∞–¥–∞—Ä—ñ–≤ —Ü–∏—Ö –Ω–∏–∑—å–∫–æ–ø—Ä–æ–±–Ω–∏—Ö –±–æ—Ç—ñ–≤.

–í–∞—à—ñ –ª–æ–≥–∏ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç—å –≤—ñ–¥ —Ç–∏—Å—è—á –Ω–µ–≤–¥–∞–ª–∏—Ö —Å–ø—Ä–æ–± –≤—Ö–æ–¥—É –Ω–∞ –≥–æ–¥–∏–Ω—É –¥–æ –º–∞–π–∂–µ –Ω—É–ª—è. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –∫–æ–ª–∏ –≤–∏ *–≤—Å–µ –∂ —Ç–∞–∫–∏* –±–∞—á–∏—Ç–µ –Ω–µ–≤–¥–∞–ª–∏–π –ª–æ–≥—ñ–Ω —É –≤–∞—à–∏—Ö –ª–æ–≥–∞—Ö, –≤–∏ –∑–Ω–∞—î—Ç–µ, —â–æ —Ü–µ —Ä–µ–∞–ª—å–Ω–∞ –∞–Ω–æ–º–∞–ª—ñ—è, –≤–∞—Ä—Ç–∞ —Ä–æ–∑—Å–ª—ñ–¥—É–≤–∞–Ω–Ω—è. –¶–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —à—É–º –Ω–∞ —Å–∏–≥–Ω–∞–ª.

### –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è Ansible

–ó–º—ñ–Ω–∞ –ø–æ—Ä—Ç—É ‚Äî —Ü–µ –ø—Ä–æ—Å—Ç–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è `/etc/ssh/sshd_config`, –∑–∞ —è–∫–∏–º —Å–ª—ñ–¥—É—î –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤—ñ—Å—É. –ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–º—ñ–Ω–Ω—É –¥–ª—è –Ω–æ–º–µ—Ä–∞ –ø–æ—Ä—Ç—É, —â–æ–± –π–æ–≥–æ –±—É–ª–æ –ª–µ–≥–∫–æ –∑–º—ñ–Ω–∏—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ.

```yaml
# playbook.yml snippet
- name: Change SSH port to a non-standard port
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Port\s+'
    line: "Port {{ ssh_custom_port }}"
    validate: '/usr/sbin/sshd -t -f %s'
  notify: Restart SSH
```

## 2\. –§—ñ–ª–æ—Å–æ—Ñ—ñ—è –§–∞—î—Ä–≤–æ–ª—É: Default Deny

–§–∞—î—Ä–≤–æ–ª ‚Äî —Ü–µ –≤–∞—à —Ü–∏—Ñ—Ä–æ–≤–∏–π –ø—Ä–∏–∫–æ—Ä–¥–æ–Ω–Ω–∏–∫. –í—ñ–Ω —ñ–Ω—Å–ø–µ–∫—Ç—É—î –∫–æ–∂–µ–Ω –º–µ—Ä–µ–∂–µ–≤–∏–π –ø–∞–∫–µ—Ç, —â–æ –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è —É–≤—ñ–π—Ç–∏ –∞–±–æ –≤–∏–π—Ç–∏ –∑ –≤–∞—à–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.

–ù–∞–π–∫—Ä–∏—Ç–∏—á–Ω—ñ—à–∞ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—è –≤ –¥–∏–∑–∞–π–Ω—ñ —Ñ–∞—î—Ä–≤–æ–ª—É ‚Äî —Ü–µ –ø–æ–ª—ñ—Ç–∏–∫–∞ **Default Deny** (–ó–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ –∑–∞ –ó–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º).

  * **–ü–æ–≥–∞–Ω–∞ –ü–æ–ª—ñ—Ç–∏–∫–∞ (Default Allow):** –í—Å–µ –¥–æ–∑–≤–æ–ª–µ–Ω–æ, –∫—Ä—ñ–º —Ä–µ—á–µ–π, —è–∫—ñ —è —è–≤–Ω–æ –±–ª–æ–∫—É—é. (–¶–µ –≤–∞–∂–∫–æ –∫–µ—Ä—É–≤–∞—Ç–∏ —ñ –Ω–µ–±–µ–∑–ø–µ—á–Ω–æ).
  * **–•–æ—Ä–æ—à–∞ –ü–æ–ª—ñ—Ç–∏–∫–∞ (Default Deny):** –í—Å–µ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ, –∫—Ä—ñ–º —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–æ–≥–æ —Ç—Ä–∞—Ñ—ñ–∫—É, —è–∫–∏–π —è —è–≤–Ω–æ –¥–æ–∑–≤–æ–ª—è—é.

–ú–∏ –Ω–∞–ª–∞—à—Ç—É—î–º–æ –Ω–∞—à—ñ —Ñ–∞—î—Ä–≤–æ–ª–∏ —Ç–∞–∫, —â–æ–± –≤—ñ–¥–∫–∏–¥–∞—Ç–∏ –≤—Å—ñ –≤—Ö—ñ–¥–Ω—ñ –∑–∞–ø–∏—Ç–∏ –Ω–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, –∞ –ø–æ—Ç—ñ–º –ø—Ä–æ—Å–≤–µ—Ä–¥–ª–∏–º–æ —î–¥–∏–Ω–∏–π, —Ç–æ—á–Ω–∏–π –æ—Ç–≤—ñ—Ä –¥–ª—è –Ω–∞—à–æ–≥–æ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–æ—Ä—Ç—É SSH.

## 3\. –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è Linux: UFW (Uncomplicated Firewall)

–ù–∞ Linux (–∑–æ–∫—Ä–µ–º–∞ Ubuntu/Debian, –Ω–∞—à—ñ–π —Ü—ñ–ª—ñ), –±–∞–∑–æ–≤–∏–π —Ñ–∞—î—Ä–≤–æ–ª —è–¥—Ä–∞ —Å–∫–ª–∞–¥–Ω–∏–π (`nftables` –∞–±–æ `iptables`). –©–æ–± –∑—Ä–æ–±–∏—Ç–∏ –π–æ–≥–æ –∫–µ—Ä–æ–≤–∞–Ω–∏–º, –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —à–∞—Ä –∞–±—Å—Ç—Ä–∞–∫—Ü—ñ—ó –ø—ñ–¥ –Ω–∞–∑–≤–æ—é **UFW**.

UFW —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–∏–π –±—É—Ç–∏ –ø—Ä–æ—Å—Ç–∏–º —ñ —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–º –¥–ª—è –ª—é–¥–∏–Ω–∏. –í—ñ–Ω —ñ–¥–µ–∞–ª—å–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –µ—Ç–æ—Å—É "—Å–ø–æ–∫—ñ–π–Ω–æ—ó —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó".

### –ü—ñ–¥—Ö—ñ–¥ Ansible

Ansible –º–∞—î —á—É–¥–æ–≤–∏–π –≤–±—É–¥–æ–≤–∞–Ω–∏–π –º–æ–¥—É–ª—å –¥–ª—è UFW, —è–∫–∏–π —Ä–æ–±–∏—Ç—å –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –ª–µ–≥–∫–æ—é. –ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É –Ω–∞ –ø–æ—Ä—è–¥–æ–∫: –º–∏ –¥–æ–∑–≤–æ–ª—è—î–º–æ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –ø–æ—Ä—Ç *–¥–æ —Ç–æ–≥–æ*, —è–∫ —É–≤—ñ–º–∫–Ω—É—Ç–∏ —Ñ–∞—î—Ä–≤–æ–ª.

```yaml
# roles/firewall_linux/tasks/main.yml
---
- name: Ensure UFW is installed
  apt:
    name: ufw
    state: present

- name: Set default policies (Default Deny)
  community.general.ufw:
    policy: deny
    direction: incoming

- name: Allow outgoing traffic
  community.general.ufw:
    policy: allow
    direction: outgoing

- name: Allow SSH on custom port
  community.general.ufw:
    rule: allow
    port: "{{ ssh_custom_port }}"
    proto: tcp
    comment: "Allow custom SSH access"

# –ö—Ä–∏—Ç–∏—á–Ω–æ: –£–≤—ñ–º–∫–Ω—É—Ç–∏ —Ñ–∞—î—Ä–≤–æ–ª –æ—Å—Ç–∞–Ω–Ω—ñ–º, –ø—ñ—Å–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª.
- name: Enable UFW firewall
  community.general.ufw:
    state: enabled
```

## 4\. –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è FreeBSD: PF (Packet Filter)

FreeBSD –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —ñ–Ω—à–∏–π –ø—ñ–¥—Ö—ñ–¥. –á–π –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ "–Ω–µ—Å–∫–ª–∞–¥–Ω—ñ" –æ–±–≥–æ—Ä—Ç–∫–∏, —Ç–æ–º—É —â–æ —ó—ó –Ω–∞—Ç–∏–≤–Ω–∏–π —Ñ–∞—î—Ä–≤–æ–ª, **PF (Packet Filter)**, –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∏–π —Å–≤–æ—ó–º —á–∏—Å—Ç–∏–º, —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–º —ñ –ø–æ—Ç—É–∂–Ω–∏–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–æ–º –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó.

–ù–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ Linux, –¥–µ –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–æ–¥—É–ª—å Ansible –¥–ª—è –∑–∞–ø—É—Å–∫—É –∫–æ–º–∞–Ω–¥, –Ω–∞ FreeBSD –º–∏ –∫–µ—Ä—É—î–º–æ —Ñ–∞—î—Ä–≤–æ–ª–æ–º, —à–∞–±–ª–æ–Ω—ñ–∑—É—é—á–∏ –π–æ–≥–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É. –¶–µ –ø—ñ–¥–∫—Ä–µ—Å–ª—é—î –∫–ª—é—á–æ–≤—É –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å –≤ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—ñ –¥–≤–æ–º–∞ –û–°.

### –ü—ñ–¥—Ö—ñ–¥ Ansible

–ú–∏ –≤–∏–∑–Ω–∞—á–∞—î–º–æ –Ω–∞—à—ñ –ø—Ä–∞–≤–∏–ª–∞ —É —Ñ–∞–π–ª—ñ —à–∞–±–ª–æ–Ω—É (`pf.conf.j2`) —ñ —Ä–æ–∑–≥–æ—Ä—Ç–∞—î–º–æ –π–æ–≥–æ –≤ `/etc/pf.conf`.

**–®–∞–±–ª–æ–Ω (`templates/pf.conf.j2`):**

```pf
# /etc/pf.conf - Managed by Ansible

# Macros
# –í–∏–∑–Ω–∞—á–∏—Ç–∏ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–∏–Ω–∞–º—ñ—á–Ω–æ
ext_if = "{{ ansible_default_ipv4.interface }}"
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –Ω–∞—à—É –∑–º—ñ–Ω–Ω—É –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–æ—Ä—Ç—É
ssh_port = "{{ ssh_custom_port }}"

# Options
set block-policy drop
set skip on lo0

# Normalization
scrub in on $ext_if all fragment reassemble

# --- –ó–û–õ–û–¢–ï –ü–†–ê–í–ò–õ–û: DEFAULT DENY ---
# –ë–ª–æ–∫—É–≤–∞—Ç–∏ –≤—Å–µ, —â–æ –≤—Ö–æ–¥–∏—Ç—å, –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
block in all
# –î–æ–∑–≤–æ–ª–∏—Ç–∏ –≤–µ—Å—å —Ç—Ä–∞—Ñ—ñ–∫, —â–æ –≤–∏—Ö–æ–¥–∏—Ç—å
pass out all keep state

# –ü—Ä–æ—Å–≤–µ—Ä–¥–ª–∏—Ç–∏ –æ—Ç–≤—ñ—Ä: –î–æ–∑–≤–æ–ª–∏—Ç–∏ SSH –Ω–∞ –Ω–∞—à–æ–º—É –∫–∞—Å—Ç–æ–º–Ω–æ–º—É –ø–æ—Ä—Ç—É
pass in on $ext_if proto tcp from any to any port $ssh_port keep state
```

**–ó–∞–≤–¥–∞–Ω–Ω—è –ü–ª–µ–π–±—É–∫–∞:**
–ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–æ–¥—É–ª—å `template`, —â–æ–± —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ —Ñ–∞–π–ª, —ñ handler, —â–æ–± –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PF. –ú–∏ —Ç–∞–∫–æ–∂ –ø–æ–≤–∏–Ω–Ω—ñ –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ —Å–µ—Ä–≤—ñ—Å PF —É–≤—ñ–º–∫–Ω–µ–Ω–æ –≤ `/etc/rc.conf`.

```yaml
# roles/firewall_freebsd/tasks/main.yml
---
- name: Enable PF in rc.conf
  service:
    name: pf
    enabled: yes

- name: Deploy PF configuration template
  template:
    src: pf.conf.j2
    dest: /etc/pf.conf
    mode: '0600'
    # –ö–†–ò–¢–ò–ß–ù–û: –í–∞–ª—ñ–¥—É–≤–∞—Ç–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–µ—Ä–µ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º, —â–æ–± –∑–∞–ø–æ–±—ñ–≥—Ç–∏ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è–º!
    validate: 'pfctl -nf %s'
  notify: Reload PF
```

## 5\. –ê–∫—Ç–∏–≤–Ω–∏–π –ó–∞—Ö–∏—Å—Ç: Fail2Ban

–ú–∏ –ø–µ—Ä–µ–º—ñ—Å—Ç–∏–ª–∏ SSH —ñ –ø–æ–±—É–¥—É–≤–∞–ª–∏ —Ñ–∞—î—Ä–≤–æ–ª. –ù–∞—à—ñ –ª–æ–≥–∏ —Å—Ç–∞–ª–∏ —Ç–∏—Ö—ñ—à–∏–º–∏, —ñ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –ª–∏—à–µ –æ–¥–∏–Ω –ø–æ—Ä—Ç.

–ê–ª–µ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∏ –≤—Å–µ —â–µ –º–æ–∂—É—Ç—å –∑–Ω–∞–π—Ç–∏ —Ü–µ–π –ø–æ—Ä—Ç —ñ –ø–æ—á–∞—Ç–∏ –ø–µ—Ä–µ–±–∏—Ä–∞—Ç–∏ –∫–ª—é—á—ñ. –°—Ç–∞—Ç–∏—á–Ω–µ –ø—Ä–∞–≤–∏–ª–æ —Ñ–∞—î—Ä–≤–æ–ª—É –¥–æ–∑–≤–æ–ª—è—î —ó–º –ø—Ä–æ–±—É–≤–∞—Ç–∏ –≤—ñ—á–Ω–æ. –ù–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –∞–∫—Ç–∏–≤–Ω–∏–π –∑–∞—Ö–∏—Å—Ç. –ù–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω –≤–∏—à–∏–±–∞–ª–∞.

**Fail2Ban** ‚Äî —Ü–µ —Ç–æ–π –≤–∏—à–∏–±–∞–ª–∞. –í—ñ–Ω –º–æ–Ω—ñ—Ç–æ—Ä–∏—Ç—å –ª–æ–≥-—Ñ–∞–π–ª–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ª–æ–≥–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó), —à—É–∫–∞—é—á–∏ –ø–∞—Ç–µ—Ä–Ω–∏ –Ω–µ–≤–¥–∞—á. –Ø–∫—â–æ IP-–∞–¥—Ä–µ—Å–∞ –Ω–µ –º–æ–∂–µ —É–≤—ñ–π—Ç–∏ –∑–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ —Ä–∞–∑—ñ–≤ –∑–∞ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä—ñ–æ–¥, Fail2Ban –¥–∏–Ω–∞–º—ñ—á–Ω–æ –æ–Ω–æ–≤–ª—é—î —Ñ–∞—î—Ä–≤–æ–ª (UFW –∞–±–æ PF), —â–æ–± –∑–∞–±–∞–Ω–∏—Ç–∏ —Ü—é IP-–∞–¥—Ä–µ—Å—É –Ω–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π —á–∞—Å.

### –ü—ñ–¥—Ö—ñ–¥ Ansible

–ú–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Fail2Ban —ñ —Ä–æ–∑–≥–æ—Ä—Ç–∞—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª, —è–∫–∏–π –≤–∏–∑–Ω–∞—á–∞—î –Ω–∞—à—ñ –ø—Ä–∞–≤–∏–ª–∞ "jail" (–≤'—è–∑–Ω–∏—Ü—ñ).

```yaml
# roles/fail2ban/tasks/main.yml
---
- name: Ensure Fail2Ban is installed
  package:
    name: fail2ban
    state: present

- name: Deploy Fail2Ban jail configuration
  template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
  notify: Restart Fail2Ban
```

–£ –Ω–∞—à–æ–º—É —à–∞–±–ª–æ–Ω—ñ –º–∏ –∫–∞–∂–µ–º–æ Fail2Ban –º–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ SSH –Ω–∞ –Ω–∞—à–æ–º—É –Ω–æ–≤–æ–º—É *–∫–∞—Å—Ç–æ–º–Ω–æ–º—É –ø–æ—Ä—Ç—É*.

## üß™ –ü—Ä–∞–∫—Ç–∏—á–Ω–∞ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è: –ü–æ–±—É–¥–æ–≤–∞ –ü–µ—Ä–∏–º–µ—Ç—Ä–∞ (–ë–µ–∑–ø–µ—á–Ω–æ)

–ú–∏ –∑–±–∏—Ä–∞—î–º–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ –ø–æ—Ä—Ç–∏ SSH —ñ —É–≤—ñ–º–∫–Ω—É—Ç–∏ —Ñ–∞—î—Ä–≤–æ–ª–∏. **–¶–µ –≤–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫.**

–ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Ü–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä—ñ –±–µ–∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è. –Ø —Å—Ç–≤–æ—Ä–∏–≤ –Ω–æ–≤–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π GitHub, **`perimeter-lab`**, –∑ –ø–æ–≤–Ω–∏–º –ø–ª–µ–π–±—É–∫–æ–º Ansible, —è–∫–∏–π –±–µ–∑–ø–µ—á–Ω–æ –æ—Ä–∫–µ—Å—Ç—Ä—É—î –≤—Å—ñ —Ü—ñ –∫—Ä–æ–∫–∏ –Ω–∞ Linux —Ç–∞ FreeBSD Vagrant boxes.

**üëâ –ö–ª–æ–Ω—É–π—Ç–µ –õ–∞–±—É:** [github.com/d3ep0ps/security-lab](https://github.com/d3ep0ps/security-lab)

–¶—è –ª–∞–±–∞:

1.  –ü—ñ–¥–Ω—ñ–º–µ –ª–æ–∫–∞–ª—å–Ω—ñ Linux —Ç–∞ FreeBSD VM.
2.  –ó–º—ñ–Ω–∏—Ç—å —ó—Ö–Ω—ñ–π –ø–æ—Ä—Ç SSH –Ω–∞ `2222`.
3.  –ù–∞–ª–∞—à—Ç—É—î —Ç–∞ —É–≤—ñ–º–∫–Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ñ–∞—î—Ä–≤–æ–ª (UFW –∞–±–æ PF), –≥–∞—Ä–∞–Ω—Ç—É—é—á–∏, —â–æ –Ω–æ–≤–∏–π –ø–æ—Ä—Ç –≤—ñ–¥–∫—Ä–∏—Ç–∏–π.
4.  –í—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞ –Ω–∞–ª–∞—à—Ç—É—î Fail2Ban, —â–æ–± —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—Ç–∏ –∑–∞ –Ω–æ–≤–∏–º –ø–æ—Ä—Ç–æ–º –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ—Ä—É—à–Ω–∏–∫—ñ–≤.

## –ö—ñ–Ω—Ü–µ–≤–∏–π –°—Ç–∞–Ω

–ü–æ—î–¥–Ω–∞–≤—à–∏ –ß–∞—Å—Ç–∏–Ω—É 1 —ñ –ß–∞—Å—Ç–∏–Ω—É 2, –≤–∏ –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏–ª–∏ –≤—Ä–∞–∑–ª–∏–≤—É –¥–µ—Ñ–æ–ª—Ç–Ω—É —ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ—é –Ω–∞ –∑–∞—Ö–∏—â–µ–Ω–∏–π Unix-–±–∞—Å—Ç—ñ–æ–Ω.

  * **–Ü–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å:** –î–æ–∑–≤–æ–ª–µ–Ω–∞ —Ç—ñ–ª—å–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∑–∞ –∫–ª—é—á–∞–º–∏.
  * **–ù–µ—è—Å–Ω—ñ—Å—Ç—å:** –°–µ—Ä–≤—ñ—Å SSH —Å—Ö–æ–≤–∞–Ω–∏–π –Ω–∞ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –ø–æ—Ä—Ç—É, –∑–∞–≥–ª—É—à–∞—é—á–∏ 99% —à—É–º—É.
  * **–ü–µ—Ä–∏–º–µ—Ç—Ä:** –§–∞—î—Ä–≤–æ–ª "default-deny" –±–ª–æ–∫—É—î –≤–µ—Å—å —ñ–Ω—à–∏–π –¥–æ—Å—Ç—É–ø.
  * **–ê–∫—Ç–∏–≤–Ω–∏–π –ó–∞—Ö–∏—Å—Ç:** –ë—É–¥—å-—è–∫–∞ IP, —è–∫–∞ –∑–Ω–∞–π–¥–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –ø–æ—Ä—Ç —ñ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏–º–µ –Ω–∏–º, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –±–∞–Ω–∏—Ç—å—Å—è.

–¶–µ –±–∞–∑–æ–≤–∞ –ø–æ–∑–∏—Ü—ñ—è –±–µ–∑–ø–µ–∫–∏ –¥–ª—è –±—É–¥—å-—è–∫–æ—ó —Å–∏—Å—Ç–µ–º–∏, —â–æ –¥–∏–≤–∏—Ç—å—Å—è –≤ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç.
