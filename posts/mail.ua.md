# Поштовий стек: Postfix, Dovecot і війна зі спамом

> **Відправити імейл легко. Доставити його — це війна.**

> [!Важливо]
> 
> Відкрийте термінал зараз. Не просто читайте цю статтю. Ви тут не для того, щоб копіювати конфіги; ви тут, щоб побудувати комунікаційну інфраструктуру з нуля.
> Продовжуйте, тільки якщо готові траблшутити, дебажити і розуміти кожен рядок, який вводите.

Якщо налаштування Apache схоже на навчання водінню, то налаштування поштового сервера — це як вчитися керувати гелікоптером, поки по тобі стріляють.

Це найбільш складна, крихка і залежна від репутації система, яку ви коли-небудь будуватимете.

Стандартна порада у 2025 році: **"Не робіть цього."**
Використовуйте Google Workspace. Використовуйте Microsoft 365. Використовуйте Amazon SES.

Для стартапу, який намагається швидко запуститися, це хороша порада. Але для системного архітектора — це відмовка.

Якщо ви не побудуєте поштовий сервер хоча б раз, ви не зрозумієте інтернет. Ви не зрозумієте **Ідентичність**, **Довіру** або той величезний обсяг автоматизованого зла, що проходить через мережу щосекунди.

За роки роботи в провайдера та хостинг компаній я не просто запускав поштові сервери; я керував **Репутацією**. Я бачив, як блоки IP потрапляли в чорні списки через один зламаний плагін WordPress. Я бачив, як легітимний бізнес-трафік зникав у нікуди через відсутній PTR-запис.

Сьогодні ми побудуємо поштовий стек рівня оператора зв'язку (carrier-grade) на наших серверах Linux чи FreeBSD. Ми зробимо це "Шляхом хостинг-провайдера" — не з системними користувачами, а з **Віртуальними користувачами** в базі даних, здатними обслуговувати тисячі доменів на одній машині.



## 1\. Архітектура: Водії вантажівок проти Завідувачів складом

Перш ніж щось встановлювати, нам потрібна ментальна модель. Більшість людей плутають SMTP, IMAP та POP3. Ось як вони насправді взаємодіють.

1.  **MTA (Postfix):** Уявіть Postfix як **Водія вантажівки**. Його робота — перемістити пошту з Сервера А на Сервер Б, використовуючи **SMTP** (Simple Mail Transfer Protocol, порт 25). Він також обробляє безпечну відправку від користувачів через **Порт 587 (TLS)**. Йому байдуже, що всередині конверта. Він не зберігає пошту для читання користувачами. Він просто везе.
2.  **MDA (Dovecot):** Уявіть Dovecot як **Завідувача складом**. Коли вантажівка (Postfix) прибуває, вона передає пошту Dovecot (через **LMTP**). Dovecot сортує її по полицях (файли на диску) і дозволяє користувачам заходити та перевіряти свої скриньки через **IMAP** (порт 143/993).
3.  **База даних (MySQL):** Ми **не** будемо використовувати системні акаунти Linux (`useradd vitaliy`). Це не масштабується. Ми будемо зберігати домени, скриньки та аліаси в MySQL. Це **Віртуальний хостинг**.
4.  **Інтерфейс:**
      * **PostfixAdmin:** Веб-панель для нас (адмінів) для створення доменів/користувачів у MySQL.
      * **Roundcube:** Веб-клієнт пошти для користувачів.



## 2\. Передумови: DNS — це доля

Ви не можете запустити поштовий сервер без ідеального DNS. Якщо ваш DNS недбалий, Gmail та Outlook відхилять вас миттєво.

Перейдіть до вашого менеджера DNS (або сервера BIND, який ми побудували в минулій статті) і переконайтеся, що у вас є:

1.  **A Record:** `mail.d3ep0ps.com` -\> `1.2.3.4` (IP вашого сервера).
2.  **MX Record:** `d3ep0ps.com` -\> `10 mail.d3ep0ps.com`.
3.  **PTR Record (Reverse DNS):**
      * *Це найважливіше.* Ви повинні попросити вашого провайдера або хмарного оператора встановити **Reverse DNS** для `1.2.3.4` на `mail.d3ep0ps.com`.
      * **Чому?** Коли ви підключаєтесь до Google, вони роблять перевірку. "Ти кажеш, що ти `mail.d3ep0ps.com`. Я бачу твій IP `1.2.3.4`. Якщо я перевірю `1.2.3.4`, чи вказує він назад на `mail.d3ep0ps.com`?"
      * **Перевірте це:** `dig -x 1.2.3.4 +short`. Він ПОВИНЕН повернути `mail.d3ep0ps.com`.
      * **СТОП.** Не продовжуйте, доки не побачите це значення. Якщо ви пропустите це, все інше не працюватиме.
      * Якщо відповідь "Ні" (або загальне `ip-1-2-3-4.aws.com`), ви спамер. Заблоковано.



## 3\. Встановлення: Пакети проти Шляху Архітектора

### Linux (Debian/Ubuntu)

Нам потрібен поштовий стек і конектори до бази даних.

```bash
sudo apt install postfix postfix-mysql dovecot-core dovecot-imapd dovecot-lmtpd dovecot-mysql
```

*Під час встановлення виберіть "Internet Site" і вкажіть ваш FQDN.*

### FreeBSD (Вибір Архітектора)

FreeBSD постачається з **Sendmail** у базовій системі. Нам потрібно вимкнути його і встановити наш сучасний стек.

**"Легкий" шлях (Бінарні пакети):**
Якщо ви використовуєте стандартний `pkg`, вам часто потрібно встановлювати окремі пакети драйверів баз даних:

```bash
pkg install postfix postfix-mysql dovecot dovecot-mysql mysql80-server postfixadmin roundcube
```

**"Правильний" шлях (Порти):**
Ось пастка, яку я бачив багато разів: готові бінарні пакети є універсальними. Їм часто бракує специфічних опцій компіляції або вони страждають від невідповідності бібліотек. Наприклад, я стикався з критичними збоями, коли бінарний пакет `postfix-mysql-3.10.4` не міг працювати з `mysql84-server` через конфлікти версій клієнтських бібліотек. Покладатися на `pkg` тут — це гра в рулетку.

Щоб гарантувати стабільність, ми компілюємо з **Портів** і **Блокуємо** пакет.

```bash
# 1. Компілюємо Postfix з підтримкою MySQL
cd /usr/ports/mail/postfix
make config  # [X] Check MYSQL and SASL
make install clean

# 2. Компілюємо Dovecot з підтримкою MySQL
cd /usr/ports/mail/dovecot
make config  # [X] Check MYSQL
make install clean

# 3. КРИТИЧНО: Блокуємо пакети
# Запобігаємо заміні наших кастомних бінарників через 'pkg upgrade'
pkg lock postfix
pkg lock dovecot
```

**Фінальне налаштування:**
Тепер вимкніть базовий Sendmail і увімкніть наш новий стек у `/etc/rc.conf`:

```bash
sysrc sendmail_enable="NO"
sysrc sendmail_submit_enable="NO"
sysrc sendmail_outbound_enable="NO"
sysrc sendmail_msp_queue_enable="NO"

sysrc postfix_enable="YES"
sysrc dovecot_enable="YES"
```



## 4\. База даних: Віртуальні користувачі

Ми не створюємо користувачів у `/etc/passwd`. Ми створюємо їх у SQL.
Це дозволяє нам хостити `ceo@company-a.com` та `support@company-b.com` на одному сервері, навіть якщо вони мають однакове ім'я користувача "admin" або "support".

**PostfixAdmin** обробляє створення схеми для нас.

1.  Створіть базу даних `postfix`.
2.  Створіть користувача `postfix_admin` з правами.
3.  Налаштуйте PostfixAdmin (`config.local.php`) для підключення до неї.
4.  Запустіть майстер налаштування у вашому браузері (`http://your-ip/postfixadmin/setup.php`).

Тепер замість `useradd`, ви заходите у веб-інтерфейс і натискаєте "Add Mailbox".



## 4.1 Системний користувач (Власник файлів)

Нам потрібен один користувач в ОС, який володітиме всіма файлами пошти. Postfix і Dovecot "ставатимуть" цим користувачем під час читання/запису на диск.

**Linux:**
```bash
groupadd -g 5000 vmail
useradd -g vmail -u 5000 vmail -d /var/vmail -s /usr/sbin/nologin
mkdir -p /var/vmail
chown -R vmail:vmail /var/vmail
```

**FreeBSD:**
```bash
pw groupadd vmail -g 5000
pw useradd vmail -u 5000 -g vmail -d /var/vmail -s /usr/sbin/nologin
mkdir -p /var/vmail
chown -R vmail:vmail /var/vmail
```



## 5\. Конфігурація: Postfix (Перевізник)

Нам потрібно навчити Postfix припинити дивитися на Unix-користувачів і почати дивитися в MySQL.

**Файл:** `/usr/local/etc/postfix/main.cf` (FreeBSD) або `/etc/postfix/main.cf` (Linux).

```text
# Identity
myhostname = mail.d3ep0ps.com
mydomain = d3ep0ps.com

# The Hand-off (Send mail to Dovecot via LMTP)
virtual_transport = lmtp:unix:private/dovecot-lmtp

# Lookups (Tell Postfix how to read MySQL)
virtual_mailbox_domains = proxy:mysql:/usr/local/etc/postfix/sql/mysql_virtual_domains_maps.cf
virtual_mailbox_maps = proxy:mysql:/usr/local/etc/postfix/sql/mysql_virtual_mailbox_maps.cf
virtual_alias_maps = proxy:mysql:/usr/local/etc/postfix/sql/mysql_virtual_alias_maps.cf

# SECURITY: Prevent Open Relays
# Only allow authenticated users or my network to send mail.
smtpd_relay_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination
```

**[Особиста нотатка]:** У часи роботи в провайдері "Open Relays" (відкриті релеї) були чумою. Якщо ви зіпсуєте `smtpd_relay_restrictions`, спамери знайдуть вас за лічені хвилини і прокачають мільйони листів через ваш сервер. Ваша IP-репутація буде спалена на роки.



## 6. Конфігурація: Postfix Master (Порти)

Ми змінили `main.cf`, але нам також потрібно відкрити бічні двері. За замовчуванням Postfix слухає тільки порт 25.
Нам потрібен порт 587 (Submission), щоб наші користувачі могли безпечно надсилати пошту.

**Файл:** `/usr/local/etc/postfix/master.cf` (FreeBSD) або `/etc/postfix/master.cf` (Linux).

Знайдіть рядок для `submission` і розкоментуйте/відредагуйте його так:

```text
submission inet n       -       n       -       -       smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=encrypt
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_reject_unlisted_recipient=no
```

*Це каже Postfix: "На порту 587 вимагай шифрування і вимагай логін/пароль."*

**Виклик:** Чому 587? Чому не 25?
*Відповідь:* Провайдери блокують порт 25 для домашніх/динамічних IP, щоб зупинити спам. Порт 587 є галузевим стандартом для *submission* (авторизованої відправки). Якщо ви спробуєте налаштувати свій iPhone на відправку через порт 25, це, ймовірно, не спрацює. Використовуйте 587.



## 7. Конфігурація: Dovecot (Склад)

Dovecot робить дві речі: він автентифікує користувачів (перевіряючи пароль) і зберігає файли.

**Файл:** `/usr/local/etc/dovecot/dovecot.conf`

### Зберігання: Maildir проти mbox

Ми *завжди* використовуємо **Maildir**.

  * **mbox:** Один гігантський файл для всіх листів (`/var/mail/vitaliy`). Якщо один біт пошкодиться, ви втратите все. Блокування файлів — це кошмар.
  * **Maildir:** Один файл на кожен лист (`/var/vmail/d3ep0ps.com/vitaliy/new/17099232.server`). Це швидше, безпечніше і легше бекапити.

<!-- end list -->

```text
mail_location = maildir:/var/vmail/%d/%n
```

*%d = domain, %n = username*

### Автентифікація

Ми налаштовуємо Dovecot спілкуватися з тією ж базою MySQL, яку використовує Postfix. Після перевірки Dovecot дає Postfix "зелене світло" на прийняття листа (це SASL).



## 8. Війна зі спамом: Свята Трійця

Якщо ви зупинитесь тут, ви зможете відправляти пошту, але вона потраплятиме в папки Спам. Щоб вам довіряли, вам потрібна Трійця.

### 1\. SPF (Sender Policy Framework)

DNS TXT запис, який каже: "Тільки ці IP дозволені для відправки пошти від імені `d3ep0ps.com`."
`v=spf1 mx ip4:1.2.3.4 -all`

### 2\. DKIM (DomainKeys Identified Mail)

Криптографічний підпис у заголовку кожного листа.
Ми встановлюємо **Rspamd** (сучасна заміна SpamAssassin/Amavis) або **OpenDKIM**.
Сервер підписує лист Приватним Ключем. Світ перевіряє його Публічним Ключем у вашому DNS.
*Якщо лист змінено в дорозі, підпис ламається.*

### 3\. DMARC

Політика, яка каже Google/Yahoo, що робити, якщо SPF або DKIM не пройшли перевірку.
`_dmarc.d3ep0ps.com TXT "v=DMARC1; p=none; rua=mailto:admin@d3ep0ps.com"`
*Переклад: "Якщо перевірка не пройшла, просто скажи мені. Поки нічого не блокуй."*

**Pro Tip:** Почніть з `p=none` (Режим моніторингу). Запустіть на тиждень. Якщо легітимна пошта не ламається, перевірте звіти, ПОТІМ перемикайтеся на `p=reject` (Режим примусу).



## 9. Шар шифрування: TLS та Let's Encrypt

У 90-х пошта ходила відкритим текстом. Сьогодні це неприйнятно.
Якщо ви не шифруєте з'єднання, ваші паролі видно в мережі, і GMail позначить вашу доставку як небезпечну.

Нам потрібні **TLS Сертифікати**.
Раніше ми платили за них сотні доларів. Сьогодні ми використовуємо **Certbot (Let's Encrypt)**.

```bash
# Отримання сертифіката
certbot certonly --standalone -d mail.d3ep0ps.com
```

Потім ми кажемо Postfix і Dovecot, де лежать ці ключі.

  * **Postfix:** `smtpd_tls_cert_file` та `smtpd_tls_key_file`.
  * **Dovecot:** `ssl_cert` та `ssl_key`.



## 10. Ритуал: Тестування через Telnet та OpenSSL

Справжні інженери не тестують через Outlook. Вони тестують через командний рядок.

### Частина 1: Рукостискання SMTP (Telnet)

Ми вручну говоримо по SMTP, щоб перевірити, чи працює логіка на локальній машині.

```bash
telnet localhost 25
```

**Розмова:**

```text
Trying 127.0.0.1...
Connected to localhost.
220 mail.d3ep0ps.com ESMTP Postfix
EHLO localhost           <-- Ви кажете Привіт
250-mail.d3ep0ps.com
250-STARTTLS
MAIL FROM:<test@d3ep0ps.com>   <-- Відправник
250 2.1.0 Ok
RCPT TO:<admin@d3ep0ps.com>    <-- Отримувач
250 2.1.5 Ok
DATA                     <-- Я готовий писати
Subject: The First Email
Hello World from the command line.
.                        <-- Одна крапка завершує лист
250 2.0.0 Ok: queued as 8327A1
QUIT
```

Якщо ви бачите `queued as...`, вітання. Ваш водій вантажівки (Postfix) прийняв пакунок і передав його на склад.

### Частина 2: Зашифроване рукостискання (OpenSSL)

Telnet не вміє говорити шифруванням. Щоб протестувати сучасні захищені порти із зовнішнього світу, ми використовуємо швейцарський ніж криптографії: **OpenSSL**.

**Тестування SMTP Submission (Порт 587 + STARTTLS):**
Сучасні клієнти використовують цей порт. Вони підключаються відкритим текстом, а потім кричать "STARTTLS", щоб підвищити захист.

```bash
openssl s_client -starttls smtp -connect mail.d3ep0ps.com:587
```

*Шукайте `Verify return code: 0 (ok)` та ланцюжок сертифікатів.*

**Тестування IMAP (Порт 993 + Implicit TLS):**
IMAP очікує шифрування негайно. Telnet тут зависне. OpenSSL працює.

```bash
openssl s_client -connect mail.d3ep0ps.com:993
```

Якщо успішно, сесія відкриється, і ви побачите привітання Dovecot *всередині* зашифрованого тунелю:

```text
* OK [CAPABILITY IMAP4rev1 ...] Dovecot ready.
a1 LOGIN admin@d3ep0ps.com MySecretPassword
a1 OK [CAPABILITY ...] Logged in
```

**Чому це важливо:**
Веб-базовані "SSL Checkers" кажуть вам лише, чи відкритий порт. `openssl s_client` дозволяє вам діяти як поштовий клієнт. Ви можете побачити точно, *де* рукостискання ламається — це прострочений сертифікат? Невідповідний шифр? Чи фаєрвол дропає пакет після Hello?

### Частина 3: Навмисний саботаж (Навчання через ламання)
У вас робочий сервер? Добре. Тепер зламайте його.
1.  Зайдіть у `main.cf`. Змініть `myhostname` на `fake.d3ep0ps.com`.
2.  Запустіть `postfix reload`.
3.  Спробуйте відправити імейл. Він не пройде.
4.  **Перевірте логи.** Ви побачите помилку "Helo command rejected" або подібну невідповідність.
5.  *Виправте це.*

**Це єдиний спосіб навчитися.** Якщо ви ніколи не бачили зламаного стану, ви не знатимете, що шукати, коли воно зламається о 3-й ночі.



## 11. Операції: Фаєрвол та Логи

### Чекліст фаєрволу
Ви керуєте фортецею. Відкривайте тільки те, що необхідно:
*   **TCP 80/443:** Webmail & PostfixAdmin (HTTP/HTTPS)
*   **TCP 25:** Вхідна пошта від світу (SMTP)
*   **TCP 587:** Вихідна пошта від ваших користувачів (Submission)
*   **TCP 993:** Доступ до файлів для ваших користувачів (IMAPS)
*   *Закрийте все інше. Не відкривайте Порт 143 (Нешифрований IMAP) або Порт 110 (POP3).*

**Red Team Yourself:**
З вашого ноутбука (не сервера) спробуйте telnet на порт 143: `telnet mail.d3ep0ps.com 143`.
Якщо підключилося — **ви провалилися**. Повертайтеся до налаштувань фаєрволу і вбийте це. Воно має відвалитися по таймауту або відхилити з'єднання.

### Коли все ламається (а воно буде)
Якщо ви не можете підключитися, ваш найкращий друг — лог-файл.
*   **FreeBSD:** `tail -f /var/log/maillog`
*   **Linux:** `tail -f /var/log/mail.log`

Читайте його, поки намагаєтесь підключитися. Він скаже вам точно, чому вас відхилили ("Password mismatch", "Relay access denied", "Connection timed out").



## Висновок

Тепер у нас є повністю функціональний хостинг-стек.

  * **LAMP/FAMP** обслуговує веб.
  * **BIND** обслуговує імена.
  * **Postfix/Dovecot** обслуговує пошту.

Ми побудували мініатюрну версію Хостинг-провайдера на одному сервері.
Але на цьому сервері стає тісно. Веб-сервер працює як `www`. Поштовий сервер працює як `vmail`. Вони ділять одні й ті ж версії бібліотек, той самий `/tmp` і те саме ядро.

Якщо хакер використає вразливість у WordPress, чи зможе він прочитати ваші імейли? У цій конфігурації... так.

Час **Ізолювати**.

У наступній статті ми візьмемо бензопилу до цього моноліту. Ми представимо **FreeBSD Jails** та **Linux Chroot/Containers**, вивчаючи, як садити ці сервіси в клітку, щоб вони ніколи не могли торкнутися одне одного.
